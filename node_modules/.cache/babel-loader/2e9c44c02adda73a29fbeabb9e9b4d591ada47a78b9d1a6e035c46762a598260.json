{"ast":null,"code":"import { updateCryptoPrice, setWsConnected, setError } from '../features/crypto/cryptoSlice';\nclass WebSocketService {\n  constructor() {\n    this.ws = null;\n    this.dispatch = null;\n    this.reconnectAttempts = 0;\n    this.maxReconnectAttempts = 5;\n    this.reconnectTimeout = 3000;\n    this.lastPrices = {};\n    this.chartData = {};\n  }\n  initialize(dispatch, symbols) {\n    this.dispatch = dispatch;\n    // Initialize chart data for each symbol\n    symbols.forEach(symbol => {\n      this.chartData[symbol] = Array(24).fill(0);\n    });\n    this.connect(symbols);\n  }\n  connect(symbols) {\n    try {\n      // Convert symbols to lowercase and create subscription string\n      const streams = symbols.map(symbol => `${symbol.toLowerCase()}usdt@trade`).join('/');\n      const wsUrl = `wss://stream.binance.com:9443/ws/${streams}`;\n      this.ws = new WebSocket(wsUrl);\n      this.ws.onopen = () => {\n        console.log('WebSocket Connected');\n        this.reconnectAttempts = 0;\n        if (this.dispatch) {\n          this.dispatch(setWsConnected(true));\n        }\n      };\n      this.ws.onmessage = event => {\n        try {\n          const data = JSON.parse(event.data);\n          if (data.e === 'trade' && this.dispatch) {\n            const symbol = data.s.replace('USDT', '');\n            const price = parseFloat(data.p);\n\n            // Update chart data\n            if (this.chartData[symbol]) {\n              this.chartData[symbol] = [...this.chartData[symbol].slice(1), price];\n            }\n\n            // Only dispatch if price has changed significantly (0.01% change)\n            const lastPrice = this.lastPrices[symbol];\n            if (!lastPrice || Math.abs((price - lastPrice) / lastPrice) >= 0.0001) {\n              this.lastPrices[symbol] = price;\n              this.dispatch(updateCryptoPrice({\n                symbol,\n                price,\n                timestamp: data.T,\n                chartData: this.chartData[symbol]\n              }));\n            }\n          }\n        } catch (error) {\n          console.error('Error processing WebSocket message:', error);\n        }\n      };\n      this.ws.onclose = () => {\n        if (this.dispatch) {\n          this.dispatch(setWsConnected(false));\n        }\n        this.handleReconnect(symbols);\n      };\n      this.ws.onerror = error => {\n        console.error('WebSocket error:', error);\n        if (this.dispatch) {\n          this.dispatch(setError('WebSocket connection error'));\n        }\n      };\n    } catch (error) {\n      console.error('WebSocket connection error:', error);\n      this.handleReconnect(symbols);\n    }\n  }\n  handleReconnect(symbols) {\n    if (this.reconnectAttempts < this.maxReconnectAttempts) {\n      this.reconnectAttempts++;\n      console.log(`Attempting to reconnect... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);\n      setTimeout(() => this.connect(symbols), this.reconnectTimeout);\n    } else if (this.dispatch) {\n      this.dispatch(setError('Unable to establish WebSocket connection after multiple attempts'));\n    }\n  }\n  disconnect() {\n    if (this.ws) {\n      this.ws.close();\n      this.ws = null;\n    }\n  }\n}\nexport const wsService = new WebSocketService();\nexport default wsService;","map":{"version":3,"names":["updateCryptoPrice","setWsConnected","setError","WebSocketService","constructor","ws","dispatch","reconnectAttempts","maxReconnectAttempts","reconnectTimeout","lastPrices","chartData","initialize","symbols","forEach","symbol","Array","fill","connect","streams","map","toLowerCase","join","wsUrl","WebSocket","onopen","console","log","onmessage","event","data","JSON","parse","e","s","replace","price","parseFloat","p","slice","lastPrice","Math","abs","timestamp","T","error","onclose","handleReconnect","onerror","setTimeout","disconnect","close","wsService"],"sources":["C:/Users/DELL/OneDrive/Desktop/XYZ/src/services/websocket.ts"],"sourcesContent":["import { Dispatch } from '@reduxjs/toolkit';\r\nimport { updateCryptoPrice, setWsConnected, setError } from '../features/crypto/cryptoSlice';\r\nimport { AppDispatch } from '../app/store';\r\n\r\nclass WebSocketService {\r\n  private ws: WebSocket | null = null;\r\n  private dispatch: AppDispatch | null = null;\r\n  private reconnectAttempts = 0;\r\n  private maxReconnectAttempts = 5;\r\n  private reconnectTimeout = 3000;\r\n  private lastPrices: { [symbol: string]: number } = {};\r\n  private chartData: { [symbol: string]: number[] } = {};\r\n\r\n  initialize(dispatch: AppDispatch, symbols: string[]) {\r\n    this.dispatch = dispatch;\r\n    // Initialize chart data for each symbol\r\n    symbols.forEach(symbol => {\r\n      this.chartData[symbol] = Array(24).fill(0);\r\n    });\r\n    this.connect(symbols);\r\n  }\r\n\r\n  private connect(symbols: string[]) {\r\n    try {\r\n      // Convert symbols to lowercase and create subscription string\r\n      const streams = symbols.map(symbol => `${symbol.toLowerCase()}usdt@trade`).join('/');\r\n      const wsUrl = `wss://stream.binance.com:9443/ws/${streams}`;\r\n\r\n      this.ws = new WebSocket(wsUrl);\r\n\r\n      this.ws.onopen = () => {\r\n        console.log('WebSocket Connected');\r\n        this.reconnectAttempts = 0;\r\n        if (this.dispatch) {\r\n          this.dispatch(setWsConnected(true));\r\n        }\r\n      };\r\n\r\n      this.ws.onmessage = (event) => {\r\n        try {\r\n          const data = JSON.parse(event.data);\r\n          if (data.e === 'trade' && this.dispatch) {\r\n            const symbol = data.s.replace('USDT', '');\r\n            const price = parseFloat(data.p);\r\n            \r\n            // Update chart data\r\n            if (this.chartData[symbol]) {\r\n              this.chartData[symbol] = [...this.chartData[symbol].slice(1), price];\r\n            }\r\n            \r\n            // Only dispatch if price has changed significantly (0.01% change)\r\n            const lastPrice = this.lastPrices[symbol];\r\n            if (!lastPrice || Math.abs((price - lastPrice) / lastPrice) >= 0.0001) {\r\n              this.lastPrices[symbol] = price;\r\n              this.dispatch(updateCryptoPrice({\r\n                symbol,\r\n                price,\r\n                timestamp: data.T,\r\n                chartData: this.chartData[symbol]\r\n              }));\r\n            }\r\n          }\r\n        } catch (error) {\r\n          console.error('Error processing WebSocket message:', error);\r\n        }\r\n      };\r\n\r\n      this.ws.onclose = () => {\r\n        if (this.dispatch) {\r\n          this.dispatch(setWsConnected(false));\r\n        }\r\n        this.handleReconnect(symbols);\r\n      };\r\n\r\n      this.ws.onerror = (error) => {\r\n        console.error('WebSocket error:', error);\r\n        if (this.dispatch) {\r\n          this.dispatch(setError('WebSocket connection error'));\r\n        }\r\n      };\r\n    } catch (error) {\r\n      console.error('WebSocket connection error:', error);\r\n      this.handleReconnect(symbols);\r\n    }\r\n  }\r\n\r\n  private handleReconnect(symbols: string[]) {\r\n    if (this.reconnectAttempts < this.maxReconnectAttempts) {\r\n      this.reconnectAttempts++;\r\n      console.log(`Attempting to reconnect... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);\r\n      setTimeout(() => this.connect(symbols), this.reconnectTimeout);\r\n    } else if (this.dispatch) {\r\n      this.dispatch(setError('Unable to establish WebSocket connection after multiple attempts'));\r\n    }\r\n  }\r\n\r\n  disconnect() {\r\n    if (this.ws) {\r\n      this.ws.close();\r\n      this.ws = null;\r\n    }\r\n  }\r\n}\r\n\r\nexport const wsService = new WebSocketService();\r\nexport default wsService; "],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}